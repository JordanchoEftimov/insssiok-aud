<?php
// Почнуваме сесија за да можеме да користиме сесиски променливи
session_start();

// Вклучување на врската со базата на податоци
require 'db.php';

// Проверуваме дали формата е испратена со POST метода
if ($_SERVER['REQUEST_METHOD'] === 'POST') {

    // Го земаме корисничкото име од формата и го чистиме од празни места
    $username = trim($_POST['username']);

    // Ја земаме лозинката од формата
    $password = $_POST['password'];

    // Подготвуваме SQL израз за наоѓање на корисникот според корисничко име
    $stmt = $pdo->prepare("SELECT * FROM users WHERE username = :username");

    // Параметарот :username го заменуваме со вистинската вредност и го извршуваме изразот
    $stmt->execute([':username' => $username]);

    // Земаме еден ред од базата со даденото корисничко име
    $user = $stmt->fetch(PDO::FETCH_ASSOC);

    // Проверуваме дали корисникот постои и дали лозинката е точна
    // Функцијата password_verify() во PHP се користи за проверка дали лозинката
    // која ја внесува корисникот се совпаѓа со зачуваната хеширана лозинка во базата на податоци.
    if ($user && password_verify($password, $user['password'])) {

        // Ако е успешна најава, зачувуваме податоци за корисникот во сесијата
        $_SESSION['user_id'] = $user['id'];
        $_SESSION['username'] = $user['username'];

        // Пренасочуваме на почетната страница по успешна најава
        header("Location: index.php");
        exit();
    } else {
        // Ако најавата не е успешна, покажуваме порака за неважечко корисничко име или лозинка
        echo "Неважечко корисничко име или лозинка.";
    }
}
?>
