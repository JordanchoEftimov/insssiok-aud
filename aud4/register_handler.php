<?php

// Почнуваме сесија, бидејќи работиме со сесиски променливи
session_start();

// Вклучување на врската со базата на податоци
require 'db.php';

// Проверуваме дали методот за праќање на формата е POST
if ($_SERVER['REQUEST_METHOD'] === 'POST') {

    // Го земаме корисничкото име од формата и го чистиме од празни места
    $username = trim($_POST['username']);

    // Ја земаме лозинката од формата
    $password = $_POST['password'];

    // Проверуваме дали корисничкото име има најмалку 3 карактери и дали лозинката има најмалку 6 карактери
    if (strlen($username) < 3 || strlen($password) < 6) {
        // Ако условите не се исполнети, ја прекинува сесиската обработка со порака за грешка
        die('Корисничкото име мора да има најмалку 3 карактери, а лозинката најмалку 6.');
    }

    // Ја хешираме лозинката за да ја чуваме безбедно во базата на податоци
    $hashedPassword = password_hash($password, PASSWORD_DEFAULT);

    // Подготвуваме SQL израз за креирање на нов корисник во базата
    $stmt = $pdo->prepare("INSERT INTO users (username, password) VALUES (:username, :password)");

    try {
        // Параметарот :username и параметарот :password ги заменуваме со вистинската вредност
        // и го извршуваме изразот
        $stmt->execute([':username' => $username, ':password' => $hashedPassword]);

        // Ако се изврши успешно, прикажуваме порака за успешна регистрација
        echo "Регистрацијата е успешна! <a href='login.php'>Најави се тука</a>";
    } catch (PDOException $e) {
        // Ако се појави грешка (на пример, ако корисничкото име веќе постои)
        // 23000 е код на грешка што се користи од страна на базите на податоци
        // и се појавува кога ќе го прекршите правилото на уникатност во базата за одредено
        // својство што е UNIQUE.
        if ($e->getCode() == 23000) {
            // Прикажуваме порака за грешка дека корисничкото име е заземено
            die("Корисничкото име веќе постои.");
        } else {
            // Во спротивно, прикажуваме генерален error message со кодот на грешката
            die("Неуспешна регистрација: " . $e->getMessage());
        }
    }
}
?>
